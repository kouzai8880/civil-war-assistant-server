# 语音通讯功能测试说明

## 测试目的

本测试旨在验证实时语音通讯功能的以下核心要求：

1. **团队语音隔离**：确保不同队伍的成员之间无法互相听到对方的语音，队伍成员只能听到自己队伍内的语音。
2. **观众监听**：确保观众可以听到所有队伍成员的语音，但队伍成员听不到观众的语音。
3. **观众语音隔离**：确保观众只能与其他观众进行语音通讯，队伍成员不会被观众的语音打扰。
4. **语音状态更新**：确保用户开始或结束语音时，相关用户能及时收到状态更新通知。

## 测试环境准备

1. 确保服务器已启动，并在本地监听端口3000（默认）。
2. 安装必要的依赖：
   ```bash
   npm install socket.io-client jsonwebtoken assert
   ```
3. 确保在`config.js`中配置了正确的JWT密钥和测试参数。

## 测试用户和场景

测试将创建6个虚拟用户：
- 队伍1的两名成员（Team1Player1和Team1Player2）
- 队伍2的两名成员（Team2Player1和Team2Player2）
- 两名观众（Spectator1和Spectator2）

所有用户将加入同一个测试房间（ID: test-room-123）。

## 测试流程

### 测试1：团队语音隔离

**步骤**：
1. Team1Player1开始发送语音数据
2. 所有用户监听语音数据事件
3. 验证接收状态

**预期结果**：
- Team1Player2（同队成员）应收到Team1Player1的语音数据
- 队伍2的两名成员不应收到任何语音数据
- 两名观众都应收到Team1Player1的语音数据

### 测试2：观众语音隔离

**步骤**：
1. Spectator1开始发送语音数据
2. 所有用户监听语音数据事件
3. 验证接收状态

**预期结果**：
- 所有队伍成员（Team1Player1、Team1Player2、Team2Player1、Team2Player2）不应收到任何语音数据
- Spectator2（另一位观众）应收到Spectator1的语音数据

### 测试3：语音状态更新

**步骤**：
1. Team1Player1开始语音通讯，然后结束
2. Team1Player2监听状态更新事件
3. 验证状态更新事件接收情况

**预期结果**：
- Team1Player2应收到Team1Player1开始语音的状态更新
- Team1Player2应收到Team1Player1结束语音的状态更新

## 运行测试

执行以下命令运行测试：

```bash
node tests/voice_communication_test.js
```

## 测试结果解读

测试脚本会输出每个测试的详细结果。如果所有测试通过，将显示"语音通讯测试全部通过"并以退出代码0结束；如果任何测试失败，将显示错误信息并以退出代码1结束。

## 常见问题排查

1. **连接失败**：
   - 检查服务器是否正在运行
   - 确认测试配置中的socketUrl正确

2. **认证失败**：
   - 确保JWT密钥设置正确
   - 检查用户数据格式是否符合要求

3. **测试超时**：
   - 可能是网络延迟导致，尝试增加等待时间
   - 检查服务器是否正确处理事件 